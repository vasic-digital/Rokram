##############################################################################################################################
#
# SPDX-FileCopyrightText: 2025 Milos Vasic
# SPDX-License-Identifier: Apache-2.0
#
# CI Workflow: Pull Request Validation
# Runs comprehensive checks on pull requests before merging
#
##############################################################################################################################

name: "PR Validation"

on:
  pull_request:
    branches:
      - master
      - main
      - develop
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-info:
    name: "PR: Information"
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: "Info: PR Details"
        run: |
          echo "## Pull Request Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author**: @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.head_ref }} → ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commits**: ${{ github.event.pull_request.commits }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Files**: ${{ github.event.pull_request.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "**Additions**: +${{ github.event.pull_request.additions }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deletions**: -${{ github.event.pull_request.deletions }}" >> $GITHUB_STEP_SUMMARY

  build-check:
    name: "Build: Verify Project Builds"
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    timeout-minutes: 30

    steps:
      - name: "Checkout: PR Branch"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Cache: Gradle Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "Build: Clean Build"
        run: ./gradlew clean --info

      - name: "Build: Android Debug"
        run: ./gradlew :androidApp:assembleDebug --info --stacktrace

      - name: "Build: Shared Module"
        run: ./gradlew :shared:build --info --stacktrace

      - name: "Build: Desktop"
        run: ./gradlew :desktopApp:packageDistributionForCurrentOS --info
        continue-on-error: true

      - name: "Summary: Build Status"
        run: |
          echo "## Build Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All modules built successfully" >> $GITHUB_STEP_SUMMARY

  test-check:
    name: "Test: Run All Tests"
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    timeout-minutes: 30

    steps:
      - name: "Checkout: PR Branch"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Test: Run All Unit Tests"
        run: ./gradlew test --info --stacktrace

      - name: "Coverage: Generate Report"
        run: ./gradlew koverXmlReport koverHtmlReport
        continue-on-error: true

      - name: "Coverage: Upload to Codecov"
        uses: codecov/codecov-action@v4
        with:
          files: ./build/reports/kover/report.xml
          flags: pr-${{ github.event.pull_request.number }}
          name: pr-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: "Artifacts: Test Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-test-reports
          path: |
            **/build/reports/tests/
            build/reports/kover/
          retention-days: 7

      - name: "Summary: Test Results"
        if: always()
        run: |
          echo "## Test Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some tests failed - check artifacts for details" >> $GITHUB_STEP_SUMMARY
          fi

  lint-check:
    name: "Lint: Code Quality Check"
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    timeout-minutes: 20

    steps:
      - name: "Checkout: PR Branch"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Lint: Android Lint"
        run: ./gradlew :androidApp:lintDebug --info
        continue-on-error: true

      - name: "Lint: Detekt (Kotlin)"
        run: ./gradlew detekt --info
        continue-on-error: true

      - name: "Lint: KtLint (Formatting)"
        run: ./gradlew ktlintCheck --info
        continue-on-error: true

      - name: "Artifacts: Lint Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-lint-reports
          path: |
            **/build/reports/lint-*.html
            **/build/reports/detekt/
            **/build/reports/ktlint/
          retention-days: 7

      - name: "Summary: Lint Results"
        run: |
          echo "## Lint Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Lint reports have been generated and uploaded as artifacts." >> $GITHUB_STEP_SUMMARY

  size-check:
    name: "Check: APK Size"
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    timeout-minutes: 20

    steps:
      - name: "Checkout: Base Branch"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: "Checkout: PR Branch"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Build: Base APK"
        working-directory: base
        run: ./gradlew :androidApp:assembleDebug
        continue-on-error: true

      - name: "Build: PR APK"
        working-directory: pr
        run: ./gradlew :androidApp:assembleDebug

      - name: "Compare: APK Sizes"
        run: |
          echo "## APK Size Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          BASE_APK=$(find base/androidApp/build/outputs/apk/debug -name "*.apk" | head -1)
          PR_APK=$(find pr/androidApp/build/outputs/apk/debug -name "*.apk" | head -1)

          if [ -f "$BASE_APK" ] && [ -f "$PR_APK" ]; then
            BASE_SIZE=$(stat -f%z "$BASE_APK" 2>/dev/null || stat -c%s "$BASE_APK")
            PR_SIZE=$(stat -f%z "$PR_APK" 2>/dev/null || stat -c%s "$PR_APK")

            BASE_SIZE_MB=$(echo "scale=2; $BASE_SIZE / 1048576" | bc)
            PR_SIZE_MB=$(echo "scale=2; $PR_SIZE / 1048576" | bc)

            DIFF=$((PR_SIZE - BASE_SIZE))
            DIFF_MB=$(echo "scale=2; $DIFF / 1048576" | bc)
            PERCENT=$(echo "scale=2; ($DIFF * 100) / $BASE_SIZE" | bc)

            echo "| Metric | Base | PR | Difference |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|----|-----------:|" >> $GITHUB_STEP_SUMMARY
            echo "| Size (MB) | $BASE_SIZE_MB | $PR_SIZE_MB | $DIFF_MB |" >> $GITHUB_STEP_SUMMARY
            echo "| Change (%) | - | - | $PERCENT% |" >> $GITHUB_STEP_SUMMARY

            if [ $DIFF -gt 1048576 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "⚠️ **Warning**: APK size increased by more than 1 MB" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "Could not compare APK sizes (base or PR APK not found)" >> $GITHUB_STEP_SUMMARY
          fi

  security-check:
    name: "Security: Dependency Scan"
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    timeout-minutes: 15

    steps:
      - name: "Checkout: PR Branch"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Security: Gradle Dependency Check"
        run: ./gradlew dependencyCheckAnalyze --info
        continue-on-error: true

      - name: "Artifacts: Security Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-security-reports
          path: build/reports/dependency-check-report.html
          retention-days: 7

  validation-summary:
    name: "Validation Summary"
    runs-on: ubuntu-latest
    needs: [pr-info, build-check, test-check, lint-check, size-check, security-check]
    if: always() && github.event.pull_request.draft == false

    steps:
      - name: "Summary: Overall Status"
        run: |
          echo "## Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Size Check | ${{ needs.size-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-check.result }}" != "success" ] || \
             [ "${{ needs.test-check.result }}" != "success" ]; then
            echo "❌ **Pull request validation failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the issues before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ **All validation checks passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This pull request is ready for review." >> $GITHUB_STEP_SUMMARY
          fi

      - name: "Comment: PR Status"
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ needs.build-check.result }}';
            const testStatus = '${{ needs.test-check.result }}';
            const lintStatus = '${{ needs.lint-check.result }}';

            let emoji = '✅';
            let message = 'All validation checks passed!';

            if (buildStatus !== 'success' || testStatus !== 'success') {
              emoji = '❌';
              message = 'Some validation checks failed. Please review the workflow logs.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} **PR Validation Results**\n\n${message}\n\n| Check | Status |\n|-------|--------|\n| Build | ${buildStatus} |\n| Tests | ${testStatus} |\n| Lint | ${lintStatus} |`
            });
