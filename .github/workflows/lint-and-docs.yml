##############################################################################################################################
#
# SPDX-FileCopyrightText: 2025 Milos Vasic
# SPDX-License-Identifier: Apache-2.0
#
# CI Workflow: Lint Checks and Documentation Generation
#
##############################################################################################################################

name: "Lint & Docs"

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: lint-docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-kotlin:
    name: "Lint: Kotlin Code"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Cache: Gradle Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "Lint: Run Detekt (Kotlin)"
        run: ./gradlew detekt --info
        continue-on-error: true

      - name: "Artifacts: Detekt Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports-detekt
          path: |
            **/build/reports/detekt/
          retention-days: 14

  lint-android:
    name: "Lint: Android Code"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Cache: Gradle Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "Lint: Run Android Lint"
        run: ./gradlew :androidApp:lintDebug --info
        continue-on-error: true

      - name: "Artifacts: Android Lint Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports-android
          path: |
            androidApp/build/reports/lint-results-*.html
            androidApp/build/reports/lint-results-*.xml
          retention-days: 14

      - name: "Lint: Parse Results"
        if: always()
        run: |
          echo "## Android Lint Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "androidApp/build/reports/lint-results-debug.xml" ]; then
            ERRORS=$(grep -c 'severity="Error"' androidApp/build/reports/lint-results-debug.xml || echo "0")
            WARNINGS=$(grep -c 'severity="Warning"' androidApp/build/reports/lint-results-debug.xml || echo "0")
            echo "- **Errors**: $ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Warnings**: $WARNINGS" >> $GITHUB_STEP_SUMMARY
          else
            echo "Lint report not found" >> $GITHUB_STEP_SUMMARY
          fi

  generate-docs:
    name: "Docs: Generate API Documentation"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Cache: Gradle Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "Docs: Generate Dokka HTML"
        run: ./gradlew :shared:dokkaHtml --info
        continue-on-error: false

      - name: "Artifacts: API Documentation"
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: shared/build/dokka/html/
          retention-days: 30

      - name: "Docs: Publish to GitHub Pages (master only)"
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./shared/build/dokka/html
          destination_dir: api
          keep_files: true

      - name: "Summary: Documentation Generated"
        run: |
          echo "## API Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… API documentation has been generated successfully." >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“š Published to: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api/" >> $GITHUB_STEP_SUMMARY
          fi

  check-formatting:
    name: "Check: Code Formatting"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Format: Check Kotlin Code Style"
        run: ./gradlew ktlintCheck --info
        continue-on-error: true

      - name: "Artifacts: KtLint Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: formatting-reports
          path: |
            **/build/reports/ktlint/
          retention-days: 7

  dependency-check:
    name: "Check: Dependency Updates"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Dependencies: Check for Updates"
        run: ./gradlew dependencyUpdates --info
        continue-on-error: true

      - name: "Artifacts: Dependency Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: build/dependencyUpdates/
          retention-days: 7

  lint-summary:
    name: "Lint & Docs Summary"
    runs-on: ubuntu-latest
    needs: [lint-kotlin, lint-android, generate-docs, check-formatting]
    if: always()

    steps:
      - name: "Summary: Check Results"
        run: |
          echo "## Lint & Documentation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Kotlin Lint (Detekt) | ${{ needs.lint-kotlin.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Lint | ${{ needs.lint-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Docs | ${{ needs.generate-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Formatting | ${{ needs.check-formatting.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.generate-docs.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Documentation generation failed. Check job logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All checks completed!" >> $GITHUB_STEP_SUMMARY
          fi
