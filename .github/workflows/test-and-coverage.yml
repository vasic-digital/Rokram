##############################################################################################################################
#
# SPDX-FileCopyrightText: 2025 Milos Vasic
# SPDX-License-Identifier: Apache-2.0
#
# CI Workflow: Test Execution and Code Coverage
#
##############################################################################################################################

name: "Tests & Coverage"

on:
  push:
    branches:
      - master
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/test-and-coverage.yml'
  pull_request:
    branches:
      - master
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-shared:
    name: "Test: Shared Module"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3
        with:
          gradle-home-cache-cleanup: true

      - name: "Cache: Gradle Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "Test: Run Shared Module Tests"
        run: ./gradlew :shared:testDebugUnitTest --info --stacktrace
        continue-on-error: false

      - name: "Coverage: Generate Kover Report"
        run: ./gradlew koverXmlReport koverHtmlReport
        continue-on-error: true

      - name: "Coverage: Upload to Codecov"
        uses: codecov/codecov-action@v4
        with:
          files: ./build/reports/kover/report.xml
          flags: shared
          name: shared-module
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: "Artifacts: Test Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-shared
          path: |
            shared/build/reports/tests/
            build/reports/kover/
          retention-days: 14

      - name: "Test: Check Results"
        if: failure()
        run: |
          echo "::error::Tests failed. Check test reports artifact for details."
          exit 1

  test-android:
    name: "Test: Android Module"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Cache: Gradle Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "Test: Run Android Tests"
        run: ./gradlew :androidApp:testDebugUnitTest --info --stacktrace
        continue-on-error: false

      - name: "Artifacts: Android Test Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-android
          path: androidApp/build/reports/tests/
          retention-days: 14

  test-desktop:
    name: "Test: Desktop Module"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Test: Run Desktop Tests"
        run: ./gradlew :desktopApp:test --info --stacktrace
        continue-on-error: false

      - name: "Artifacts: Desktop Test Reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-desktop
          path: desktopApp/build/reports/tests/
          retention-days: 14

  coverage-report:
    name: "Coverage: Generate Combined Report"
    runs-on: ubuntu-latest
    needs: [test-shared, test-android, test-desktop]
    if: always()

    steps:
      - name: "Checkout: Code"
        uses: actions/checkout@v4

      - name: "Setup: Java"
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"

      - name: "Setup: Gradle"
        uses: gradle/gradle-build-action@v3

      - name: "Coverage: Generate Combined Report"
        run: |
          ./gradlew koverHtmlReport koverXmlReport
          echo "## Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage reports have been generated." >> $GITHUB_STEP_SUMMARY

      - name: "Coverage: Parse Coverage Percentage"
        id: coverage
        run: |
          if [ -f "build/reports/kover/report.xml" ]; then
            COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' build/reports/kover/report.xml | head -1 || echo "0")
            COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc -l | xargs printf "%.1f")
            echo "coverage=$COVERAGE_PCT" >> $GITHUB_OUTPUT
            echo "Coverage: $COVERAGE_PCT%" >> $GITHUB_STEP_SUMMARY
          else
            echo "coverage=0.0" >> $GITHUB_OUTPUT
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "Coverage: Upload Combined Report"
        uses: codecov/codecov-action@v4
        with:
          files: ./build/reports/kover/report.xml
          flags: combined
          name: combined-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: "Artifacts: Coverage Reports"
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: build/reports/kover/
          retention-days: 30

  test-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    needs: [test-shared, test-android, test-desktop, coverage-report]
    if: always()

    steps:
      - name: "Summary: Check Test Results"
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Shared | ${{ needs.test-shared.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.test-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Desktop | ${{ needs.test-desktop.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage-report.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-shared.result }}" != "success" ] || \
             [ "${{ needs.test-android.result }}" != "success" ] || \
             [ "${{ needs.test-desktop.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ Some tests failed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          fi
